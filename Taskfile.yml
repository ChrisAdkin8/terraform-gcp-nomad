# https://taskfile.dev
version: '3'

tasks:

  all:
    desc: Run all tasks
    cmds:
      - task: packer
      - task: apply

  packer:
    desc: Build Packer images
    cmds:
      - task: consul-config
      - task: packer-init
      - task: packer-build
      - echo "All packer builds are complete."

  apply:
    desc: Deploy infrastructure
    cmds:
      - task: terraform-init
      - task: terraform-apply

  redeploy:
    desc: Redploy infrastructure
    cmds:
      - task: destroy
      - task: clean
      - task: all

  destroy:
    desc: Destroy infrastructure
    cmds:
      - task: terraform-destroy

  clean:
    cmds:
      - |
        echo GCP Project ID: {{ .GCP_PROJECT }}
        for image in $(gcloud compute images list --project {{ .GCP_PROJECT }} --no-standard-images --format="value(NAME)"); do gcloud compute images delete --project {{ .GCP_PROJECT }} -q $image;done
    ignore_error: true
    vars:
      GCP_PROJECT:
        sh: gcloud config get-value project

  consul-config:
      dir: packer/configs
      cmds: 
        - terraform apply -auto-approve

  packer-init:
    deps: [consul-config]
    cmds:
      - packer init packer/gcp-almalinux-nomad-server.pkr.hcl
      - packer init packer/gcp-almalinux-nomad-client.pkr.hcl
      - packer init packer/gcp-almalinux-consul-server.pkr.hcl

  packer-build:
    deps: [packer-nomad-server, packer-nomad-client, packer-consul-server]

  packer-nomad-server:
    cmd: packer build -var-file=packer/variables.pkrvars.hcl packer/gcp-almalinux-nomad-server.pkr.hcl

  packer-nomad-client:
    cmd: packer build -var-file=packer/variables.pkrvars.hcl packer/gcp-almalinux-nomad-client.pkr.hcl

  packer-consul-server:
    cmd: packer build -var-file=packer/variables.pkrvars.hcl packer/gcp-almalinux-consul-server.pkr.hcl

  terraform-tfvars:
    aliases: ["tfv"]
    dir: .
    cmd: sed '/image_family.*/d' variables.pkrvars.hcl | grep project | sed 's/^gcp_//' > tf/terraform.tfvars

  terraform-init:
    dir: tf
    cmd: terraform init

  terraform-plan:
    aliases: ["plan", "tfp"]
    dir: tf
    deps: [terraform-init]
    cmd: terraform plan

  terraform-apply:
    aliases: ["tfa"]
    deps: [terraform-init]
    dir: tf
    cmd: terraform apply -parallelism=20 -auto-approve

  terraform-destroy:
    aliases: ["tfd"]
    dir: tf
    cmd: terraform destroy -parallelism=20 -auto-approve

  terraform-output:
    aliases: ["tfo"]
    dir: tf
    cmd: terraform output
